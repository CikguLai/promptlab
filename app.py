# === ğŸ“„ PDF ç”Ÿæˆå‡½æ•° (è¿™æ˜¯ VIP åŠŸèƒ½çš„æ ¸å¿ƒå¼•æ“ï¼Œä¸èƒ½åˆ ï¼) ===
def create_pdf(image, text, filename):
    pdf = FPDF()
    pdf.add_page()
    pdf.set_font("Arial", size=12)
    
    # 1. é¡¶éƒ¨æ ‡é¢˜ (å±…ä¸­, å¤§å­—)
    pdf.set_font("Arial", style='B', size=14)
    pdf.cell(190, 10, txt=f"VisionPrompter Report", ln=1, align='C')
    pdf.set_font("Arial", size=10)
    pdf.cell(190, 10, txt=f"File Reference: {filename}", ln=1, align='C')
    pdf.ln(5)
    
    # 2. æ’å…¥å›¾ç‰‡ (å¦‚æœæœ‰çš„è¯)
    if image:
        try:
            with io.BytesIO() as output:
                image.save(output, format="JPEG")
                # è°ƒæ•´å›¾ç‰‡ä½ç½® (x=15, y=35) å’Œå®½åº¦ (w=180) é€‚åº” A4
                pdf.image(output, x=15, y=35, w=180)
                pdf.ln(105) # å›¾ç‰‡å ä½é«˜åº¦ï¼Œé˜²æ­¢æ–‡å­—ç›–ä½å›¾ç‰‡
        except:
            pdf.cell(190, 10, txt="[Image Processing Error]", ln=1)
            
    # 3. æç¤ºè¯å†…å®¹ (è‡ªåŠ¨æ¢è¡Œ)
    pdf.set_font("Arial", size=11)
    safe_text = text.encode('latin-1', 'replace').decode('latin-1')
    pdf.multi_cell(0, 8, safe_text)
    
    # 4. === ğŸ’ åº•éƒ¨ç­¾å (é˜²ä¼ªæ°´å°) ===
    pdf.ln(15)
    # ç”»ä¸€æ¡æµ…ç°è‰²çš„æ¨ªçº¿
    pdf.set_draw_color(200, 200, 200)
    pdf.line(10, pdf.get_y(), 200, pdf.get_y())
    pdf.ln(5)
    
    # è‡ªåŠ¨æŠ“å–å½“å‰ç”¨æˆ·èº«ä»½
    current_user = st.session_state.get('user_email', '')
    if not current_user:
         # å¦‚æœæ˜¯ VIP ç ç™»å½•ä¸”æ²¡å¡«é‚®ç®±ï¼Œæ˜¾ç¤ºå°Šè´µèº«ä»½
         current_user = "Verified VIP Member"

    pdf.set_font("Arial", size=8, style='I')
    pdf.set_text_color(128, 128, 128) # ç°è‰²å­—ä½“æ˜¾å¾—é«˜çº§
    
    # è¿™é‡Œä¼šè‡ªåŠ¨æŠŠ Cikgu Lai æˆ–è€…ç”¨æˆ·çš„é‚®ç®±å¡«è¿›å»
    footer_text = f"Generated by VisionPrompter AI | Licensed to: {current_user} | Date: {time.strftime('%Y-%m-%d')}"
    
    pdf.cell(0, 10, txt=footer_text, ln=1, align='R')
    return pdf.output(dest='S').encode('latin-1')