# app.py
# Lai's Lab V9.3 - ç»ˆæç•Œé¢å±‚ (Enterprise Edition)
# è´Ÿè´£ï¼šUIæ¸²æŸ“ã€Secretså®‰å…¨æ³¨å…¥ã€çœŸå®PDFç”Ÿæˆã€å¤§ä¼ä¸šçº§å“ç‰Œè§„èŒƒã€å½»åº•éšè—Streamlitç‰¹å¾

import streamlit as st
import time
import base64
import os
from fpdf import FPDF 

# å¼•å…¥æœ¬åœ°æ¨¡å—
import data_matrix as dm
import logic_core as lc

# ==========================================
# 1. æ ¸å¿ƒåˆå§‹åŒ– & å®‰å…¨æ³¨å…¥ (Init & Security)
# ==========================================

st.set_page_config(
    page_title="Lai's Lab AI",
    page_icon="ğŸ§¬",
    layout="wide",
    initial_sidebar_state="expanded"
)

# ğŸ” å®‰å…¨æ³¨å…¥ï¼šä» Streamlit Secrets è¯»å–å¯†ç å¹¶æ³¨å…¥ Logic Core
if "general" in st.secrets:
    secrets = st.secrets["general"]
    
    # æ³¨å…¥ Gmail é…ç½®
    if "email_app_password" in secrets:
        lc.CONFIG["EMAIL_APP_PASSWORD"] = secrets["email_app_password"]
    if "email_sender" in secrets:
        lc.CONFIG["EMAIL_SENDER_ADDRESS"] = secrets["email_sender"]
    if "email_admin" in secrets:
        lc.CONFIG["EMAIL_ADMIN_ADDRESS"] = secrets["email_admin"]
        
    # æ³¨å…¥ API Keys
    if "telegram_token" in secrets:
        lc.CONFIG["TELEGRAM_BOT_TOKEN"] = secrets["telegram_token"]
    if "telegram_chat_id" in secrets:
        lc.CONFIG["TELEGRAM_CHAT_ID"] = secrets["telegram_chat_id"]
    if "airtable_key" in secrets:
        lc.CONFIG["AIRTABLE_API_KEY"] = secrets["airtable_key"]
    if "lemonsqueezy_key" in secrets:
        lc.CONFIG["LEMONSQUEEZY_API_KEY"] = secrets["lemonsqueezy_key"]

# åˆå§‹åŒ– Session State
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
if 'user_tier' not in st.session_state:
    st.session_state.user_tier = "Guest"
if 'user_email' not in st.session_state:
    st.session_state.user_email = ""
if 'language' not in st.session_state:
    st.session_state.language = "English"
if 'daily_usage' not in st.session_state:
    st.session_state.daily_usage = 0

# ==========================================
# 2. è¾…åŠ©å‡½æ•° (Helper UI Functions)
# ==========================================

def render_download_button(text, filename="prompt.txt"):
    """ç”Ÿæˆ TXT ä¸‹è½½æŒ‰é’®"""
    b64 = base64.b64encode(text.encode()).decode()
    href = f'<a href="data:file/txt;base64,{b64}" download="{filename}" class="download-btn">ğŸ“„ Download TXT</a>'
    st.markdown(href, unsafe_allow_html=True)

def create_pdf(content, role, mode):
    """
    ç”Ÿæˆ PDF æ–‡ä»¶ (æ”¯æŒä¸­æ–‡)
    ä¾èµ–é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ font.ttf (å¿…é¡»æ”¯æŒä¸­æ–‡ï¼Œå¦‚ NotoSansCJKtc)
    """
    pdf = FPDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    
    # å­—ä½“åŠ è½½é€»è¾‘
    font_path = "font.ttf"
    if os.path.exists(font_path):
        # ä½¿ç”¨è‡ªå®šä¹‰ä¸­æ–‡å­—ä½“
        pdf.add_font('CustomFont', '', font_path, uni=True)
        pdf.set_font("CustomFont", size=12)
    else:
        # å›é€€åˆ°æ ‡å‡†å­—ä½“ (ä¸æ”¯æŒä¸­æ–‡)
        pdf.set_font("Arial", size=12)
        # ç®€å•è¿‡æ»¤é˜²æ­¢æŠ¥é”™
        content = content.encode('latin-1', 'replace').decode('latin-1') 

    # å†™å…¥æ ‡é¢˜
    pdf.set_font_size(16)
    pdf.cell(0, 10, txt=f"Lai's Lab Export - {role} / {mode}", ln=True, align='C')
    pdf.ln(10)
    
    # å†™å…¥å†…å®¹
    pdf.set_font_size(12)
    pdf.multi_cell(0, 10, txt=content)
    
    # å†™å…¥é¡µè„š
    pdf.ln(20)
    pdf.set_font_size(10)
    pdf.cell(0, 10, txt="Generated by Lai's Lab Enterprise Engine", ln=True, align='C')
    
    return pdf.output(dest="S").encode("latin-1")

def render_footer():
    """æ¸²æŸ“å…¨å±€é¡µè„š (éšå½¢æˆ˜æœºç‰ˆ - å½»åº•éšè— Streamlit ç‰¹å¾ + ç¡…è°·å¤§å‚æ’ç‰ˆ)"""
    
    # 1. æ ¸å¼¹çº§ CSSï¼šéšè—æ‰€æœ‰ Streamlit åŸç”Ÿ UI å…ƒç´ 
    hide_st_style = """
        <style>
        /* éšè—é¡¶éƒ¨çš„ä¸»èœå• (ä¸‰é“æ ) */
        #MainMenu {visibility: hidden;}
        
        /* éšè—é¡¶éƒ¨çš„ Header æ¡ (åŒ…å« Share, Edit ç­‰æŒ‰é’®) */
        header {visibility: hidden;}
        
        /* éšè—åº•éƒ¨çš„ "Made with Streamlit" */
        footer {visibility: hidden;}
        
        /* éšè—é¡¶éƒ¨çš„å½©è‰²è£…é¥°æ¡ (Rainbow decoration) */
        div[data-testid="stDecoration"] {
            visibility: hidden;
            height: 0px;
        }
        
        /* éšè—å³ä¸Šè§’çš„ "Running" çŠ¶æ€å°äºº/åŠ¨ç”» */
        div[data-testid="stStatusWidget"] {
            visibility: hidden;
        }

        /* éšè—å¯èƒ½æ®‹ç•™çš„ Toolbar */
        div[data-testid="stToolbar"] {
            visibility: hidden;
        }

        /* è°ƒæ•´é¡¶éƒ¨ç©ºç™½ï¼Œå› ä¸º Header éšè—åä¸Šé¢ä¼šç©ºå‡ºä¸€å— */
        .block-container {
            padding-top: 2rem !important; 
            padding-bottom: 5rem;
        }
        
        /* é“¾æ¥æ‚¬åœå˜è‰² (ä¿ç•™åŸæœ¬çš„è®¾è®¡) */
        a:hover {
            color: #333 !important;
            text-decoration: underline !important;
        }
        </style>
    """
    st.markdown(hide_st_style, unsafe_allow_html=True)

    # 2. æç®€åˆ†å‰²çº¿
    st.markdown("---")
    
    # 3. ä¼ä¸šçº§ HTML æ’ç‰ˆ
    footer_html = """
    <div style="text-align: center; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding-top: 10px;">
        
        <p style="font-size: 12px; color: #666; margin-bottom: 15px;">
            <a href="#" style="color: #666; text-decoration: none; margin: 0 10px;">Privacy Policy</a> | 
            <a href="#" style="color: #666; text-decoration: none; margin: 0 10px;">Terms of Service</a> | 
            <a href="mailto:support@laislab.com" style="color: #666; text-decoration: none; margin: 0 10px;">Support</a>
        </p>

        <div style="font-size: 11px; color: #999; line-height: 1.4; max-width: 800px; margin: 0 auto 20px auto;">
            Generative AI can make mistakes; please verify important information. 
            Users are solely responsible for how they use the generated content. 
            Lai's Lab assumes no liability for actions taken based on these outputs.
        </div>

        <p style="font-size: 12px; color: #444;">
            Â© 2025 <b>Lai's Lab</b> <span style="color: #ccc; margin: 0 5px;">|</span> 
            <span style="color: #888; font-size: 11px;">System V9.3 Enterprise</span>
        </p>
        
    </div>
    """
    st.markdown(footer_html, unsafe_allow_html=True)

def logout():
    """ç™»å‡ºæ¸…ç†"""
    lc.perform_logout()
    st.session_state.clear()
    st.rerun()

# ==========================================
# 3. ç™»å½•é¡µ (Landing Page)
# ==========================================

def show_login_page():
    col1, col2 = st.columns([1, 1.5])
    
    with col1:
        st.image("https://via.placeholder.com/150", width=100) # è¯·æ›¿æ¢æ‚¨çš„Logo
        st.title("PromptLab AI V9.3")
        st.markdown("**The Ultimate Enterprise Prompt Engine**")
        st.markdown("---")
        
        # å¹¿å‘Šä½
        st.error("ğŸ”¥ **Limited Deal:** Lifetime Pro Access for **$12.90** ~~$39.90~~")
        
        tab_guest, tab_pro = st.tabs(["ğŸ‘¤ Guest Trial", "ğŸ’ Activate Pro"])
        
        with tab_guest:
            email = st.text_input("Enter Email to Start", placeholder="you@example.com")
            if st.button("ğŸš€ Start Free Trial", use_container_width=True):
                if "@" in email:
                    st.session_state.user_email = email
                    st.session_state.user_tier = "Guest"
                    st.session_state.logged_in = True
                    st.rerun()
                else:
                    st.warning("Please enter a valid email.")
                    
        with tab_pro:
            pro_email = st.text_input("Pro Email", placeholder="Email used for purchase")
            license_key = st.text_input("License Key", placeholder="LAI-XXXX-XXXX")
            
            if st.button("ğŸ’ Activate License", type="primary", use_container_width=True):
                status = lc.check_user_tier(pro_email, license_key)
                if status == "Pro":
                    st.session_state.user_email = pro_email
                    st.session_state.user_tier = "Pro"
                    st.session_state.logged_in = True
                    st.balloons()
                    time.sleep(1)
                    st.rerun()
                else:
                    st.error("Invalid Key. Please check again.")
            
            st.markdown("[â“ Lost License Key?](https://app.lemonsqueezy.com/my-orders)", unsafe_allow_html=True)

    with col2:
        # å³ä¾§å¯¹æ¯”è¡¨
        st.markdown("### Why Go Pro?")
        st.markdown("""
        | Feature | ğŸ‘¤ Guest | ğŸ’ Pro Enterprise |
        | :--- | :--- | :--- |
        | **Daily Limit** | ğŸ”’ 5 Gens/Day | âœ… **Unlimited** (FUP 1k) |
        | **Modes** | ğŸ”’ 1 Mode Only | âœ… **All 18 Modes** |
        | **Watermark** | ğŸ”’ Yes | âœ… **None (Clean)** |
        | **Speed** | ğŸ¢ Standard Queue | ğŸš€ **VIP Priority** |
        | **Support** | 3-5 Days | **1-2 Days** |
        """)
        st.info("ğŸ’¡ Join 10,000+ Educators & Creators today.")

    # åº•éƒ¨è°ƒç”¨ Footer
    render_footer()

# ==========================================
# 4. ä¸»å·¥ä½œå° (Main Workspace)
# ==========================================

def show_main_app():
    # --- A. ä¾§è¾¹æ  (Sidebar) ---
    with st.sidebar:
        st.title("ğŸ§¬ Lai's Lab")
        
        # 1. ç”¨æˆ·ä¿¡æ¯å¡ç‰‡
        tier_icon = "ğŸ’" if st.session_state.user_tier == "Pro" else "ğŸ‘¤"
        st.caption(f"{tier_icon} {st.session_state.user_tier} Plan")
        st.caption(f"ğŸ“§ {st.session_state.user_email}")
        
        # ç”¨é‡è¿›åº¦æ¡
        can_generate, remaining, max_limit = lc.check_daily_limit_by_email(
            st.session_state.user_email, 
            st.session_state.user_tier, 
            st.session_state.daily_usage
        )
        progress_val = st.session_state.daily_usage / max_limit if max_limit > 0 else 0
        st.progress(min(progress_val, 1.0))
        st.caption(f"Usage: {st.session_state.daily_usage} / {max_limit}")

        st.divider()

        # 2. å…¨å±€è®¾ç½®
        selected_lang = st.selectbox("ğŸŒ Language", list(dm.LANG_MAP.keys()))
        st.session_state.language = selected_lang
        
        # è§’è‰²é€‰æ‹©å™¨ (æ ¸å¿ƒ)
        role_list = list(dm.ROLES_CONFIG.keys())
        selected_role = st.selectbox("ğŸ­ Role", role_list)
        
        st.divider()

        # 3. æ™ºèƒ½å®¢æœ (Smart Support)
        with st.expander("ğŸ« Support / Ticket"):
            ticket_subject = st.text_input("Subject", placeholder="Refund, Key, Bug...")
            
            # æ™ºèƒ½æ‹¦æˆªé€»è¾‘
            if ticket_subject:
                should_intercept, reply = lc.smart_intercept(ticket_subject)
                if should_intercept:
                    st.warning(reply)
            
            ticket_msg = st.text_area("Message", height=100)
            
            if st.button("Submit Ticket"):
                if not ticket_subject or not ticket_msg:
                    st.error("Please fill all fields.")
                else:
                    # å‡è£…å‘é‚®ä»¶
                    ticket_id = int(time.time())
                    # è®°å½•åˆ° Airtable
                    lc.log_ticket_to_airtable(ticket_id, st.session_state.user_email, st.session_state.user_tier, ticket_subject)
                    # å‘é€çœŸå®å›æ‰§
                    success_msg = lc.send_auto_reply_email(st.session_state.user_email, st.session_state.user_tier, ticket_id, ticket_subject)
                    
                    if success_msg == "Email Sent Successfully":
                        if st.session_state.user_tier == "Pro":
                            st.success(f"ğŸ’ VIP Ticket #{ticket_id} Sent! Reply in 1-2 days.")
                        else:
                            st.success(f"âœ… Ticket #{ticket_id} Queued. Reply in 3-5 days.")
                    else:
                        st.error(f"System Error: {success_msg}")

        # 4. é€€å‡º
        st.divider()
        if st.button("ğŸšª Logout"):
            logout()

    # --- B. ä¸»ç•Œé¢ (Main Area) ---
    
    # è·å–å½“å‰è¯­è¨€çš„UIæ–‡æœ¬
    lang_pack = dm.LANG_MAP.get(selected_lang, dm.LANG_MAP["English"])
    
    st.header(f"{selected_role} Workspace")
    
    # 1. æ¨¡å¼é€‰æ‹© (Mode Selector)
    modes = list(dm.ROLES_CONFIG[selected_role].keys())
    selected_mode = st.selectbox("Select Mode", modes)
    
    # æƒé™é”åˆ¤æ–­
    is_locked = lc.check_mode_lock(st.session_state.user_tier, selected_mode)
    
    if is_locked:
        st.error(f"ğŸ”’ {selected_mode} is locked for Guest users.")
        st.info("ğŸ’ Upgrade to Pro to unlock this mode and remove watermarks.")
        st.button("ğŸ‘‰ Get Pro Access ($12.90)", disabled=True) 
    else:
        # 2. é€‰é¡¹é€‰æ‹© (Option Selector)
        options = dm.ROLES_CONFIG[selected_role][selected_mode]
        option_labels = [opt["label"] for opt in options]
        selected_option_label = st.selectbox("Select Action", option_labels)
        
        # 3. åŠ¨æ€è¾“å…¥åŒº
        # Custom é€‰é¡¹ç‰¹åˆ«æç¤º
        if "Custom" in selected_option_label:
            input_ph = "Describe specifically what you need..."
        else:
            input_ph = lang_pack["input_ph"]
            
        user_input = st.text_area("ğŸ“ Context / Details", placeholder=input_ph, height=150)
        
        # 4. ç”ŸæˆæŒ‰é’®
        if st.button(lang_pack["generate"], type="primary", use_container_width=True):
            if not user_input:
                st.warning("Please enter some context first.")
            elif not can_generate:
                st.error("ğŸš« Daily Limit Reached. Please come back tomorrow or Upgrade.")
            else:
                # === ç”Ÿæˆæµç¨‹ ===
                st.session_state.daily_usage += 1
                output_placeholder = st.empty()
                
                # Guest çš„å‡è¿›åº¦æ¡é€»è¾‘
                if st.session_state.user_tier == "Guest":
                    loading_msgs = lc.get_guest_loading_messages()
                    progress_bar = st.progress(0)
                    for i in range(100):
                        time.sleep(0.03) # æ•…æ„æ…¢
                        progress_bar.progress(i + 1)
                        if i % 20 == 0:
                            output_placeholder.info(loading_msgs[i // 20 % len(loading_msgs)])
                    progress_bar.empty()
                else:
                    # Pro ç§’å¼€
                    with st.spinner("âš¡ Pro Turbo Engine Generating..."):
                        time.sleep(0.8)

                # è°ƒç”¨å¤§è„‘ç”Ÿæˆ
                final_output, _ = lc.generate_ai_response_mock(
                    selected_role, selected_mode, selected_option_label, 
                    user_input, st.session_state.user_tier, selected_lang
                )
                
                # å±•ç¤ºç»“æœ
                output_placeholder.markdown("### âœ¨ Generated Result")
                st.text_area("Result", value=final_output, height=300)
                
                # --- C. ç»“æœæ“ä½œå¡” (Action Deck) ---
                col_a, col_b, col_c = st.columns([1, 1, 1])
                
                with col_a:
                    render_download_button(final_output)
                
                with col_b:
                    st.link_button("ğŸ¨ Open Midjourney", "https://www.midjourney.com/app/")
                    
                with col_c:
                    encoded_text = final_output[:500] 
                    wa_link = f"https://wa.me/?text={encoded_text}..."
                    st.link_button("ğŸ’¬ Share WhatsApp", wa_link)
                
                # ğŸ’ Pro ä¸“å±å¯¼å‡ºåŒº (çœŸå® PDF)
                if st.session_state.user_tier == "Pro":
                    st.divider()
                    st.markdown("#### ğŸ’ Pro Export Options")
                    
                    # ç”Ÿæˆ PDF çš„äºŒè¿›åˆ¶æ•°æ®
                    pdf_bytes = create_pdf(final_output, selected_role, selected_mode)
                    
                    col_d, col_e = st.columns(2)
                    with col_d:
                        st.download_button(
                            label="ğŸ“• Download PDF Report",
                            data=pdf_bytes,
                            file_name=f"LaisLab_{int(time.time())}.pdf",
                            mime="application/pdf",
                            use_container_width=True
                        )
                    with col_e:
                         st.download_button(
                            label="ğŸ“Š Download CSV (Coming Soon)",
                            data=final_output,
                            file_name="export.csv",
                            disabled=True,
                            use_container_width=True
                        )
    
    # åº•éƒ¨è°ƒç”¨ Footer
    render_footer()

# ==========================================
# 5. ç¨‹åºå…¥å£
# ==========================================

if __name__ == "__main__":
    if st.session_state.logged_in:
        show_main_app()
    else:
        show_login_page()
