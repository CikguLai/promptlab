# prompt_logic.py
# ==========================================
# PromptLab AI V7.3 Ultimate Edition
# æ ¸å¿ƒé€»è¾‘å¼•æ“ (Core Logic Engine)
# åŒ…å«: PASECç”Ÿæˆ, PDFæ¸²æŸ“, æ•°æ®åº“ç®¡ç†, éªŒè¯é€»è¾‘
# ==========================================

import json
import os
import datetime
import time
import requests
import base64
import re
from fpdf import FPDF

# 1. å•†ä¸šé™åˆ¶å¸¸é‡ (The Paywall Matrix)
# ------------------------------------------
LIMITS = {
    "FREE": {
        "text_daily": 5,
        "image_daily": 3,
        "batch_size": 1,
        "can_access_all_modes": False,
        "show_watermark": True
    },
    "PRO": {
        "text_daily": 1000,  # Unlimited
        "image_daily": 200,   # Fair Use
        "batch_size": 50,
        "can_access_all_modes": True,
        "show_watermark": False
    }
}

# 2. æœ¬åœ°æ•°æ®åº“ä¸æŒä¹…åŒ– (Persistence)
# ------------------------------------------
DB_FILE = 'user_db.json'

def load_db():
    if not os.path.exists(DB_FILE):
        return {}
    try:
        with open(DB_FILE, 'r') as f:
            return json.load(f)
    except:
        return {}

def save_db(db):
    with open(DB_FILE, 'w') as f:
        json.dump(db, f, indent=4)

def get_user_usage(email):
    """è·å–ç”¨æˆ·ä»Šæ—¥ç”¨é‡ï¼Œè‡ªåŠ¨å¤„ç†è·¨å¤©é‡ç½®"""
    db = load_db()
    today_str = str(datetime.date.today())
    
    if email not in db:
        db[email] = {"date": today_str, "text_count": 0, "image_count": 0}
        save_db(db)
        return db[email]
    
    # æ£€æŸ¥æ˜¯å¦è·¨å¤©
    if db[email].get("date") != today_str:
        db[email] = {"date": today_str, "text_count": 0, "image_count": 0}
        save_db(db)
    
    return db[email]

def update_user_usage(email, usage_type="text", count=1):
    """æ›´æ–°ç”¨é‡"""
    db = load_db()
    today_str = str(datetime.date.today())
    
    if email not in db or db[email].get("date") != today_str:
        db[email] = {"date": today_str, "text_count": 0, "image_count": 0}
    
    if usage_type == "image":
        db[email]["image_count"] += count
    else:
        db[email]["text_count"] += count
        
    save_db(db)

# 3. æ¿€æ´»ç éªŒè¯ (LemonSqueezy Real API)
# ------------------------------------------
def validate_license_key(key):
    """
    éªŒè¯ License Keyã€‚
    1. æ£€æŸ¥åé—¨ ADMIN-8888
    2. è°ƒç”¨ LemonSqueezy API
    """
    key = key.strip()
    if not key:
        return False
        
    # åé—¨ (æ–¹ä¾¿æµ‹è¯•)
    if key == "ADMIN-8888":
        return True
        
    # çœŸå® API éªŒè¯
    try:
        url = "https://api.lemonsqueezy.com/v1/licenses/activate"
        payload = {"license_key": key, "instance_name": "PromptLab_Web"}
        headers = {"Accept": "application/json"}
        
        response = requests.post(url, data=payload, headers=headers, timeout=5)
        data = response.json()
        
        # åªè¦ activated ä¸º True å³è§†ä¸ºæˆåŠŸ
        if data.get("activated") is True:
            return True
    except:
        # å¦‚æœç½‘ç»œä¸é€šï¼Œä½† Key æ ¼å¼çœ‹èµ·æ¥åƒ PROï¼Œä¸ºäº†ä¸å¡ä½ç”¨æˆ·ï¼Œå¯ä»¥æ”¾è¡Œ(å¯é€‰)
        # è¿™é‡Œä¸¥æ ¼ä¸€ç‚¹ï¼Œåªè¿”å› False
        pass
        
    return False

# 4. PASEC æ ¸å¿ƒç”Ÿæˆå¼•æ“ (The Brain)
# ------------------------------------------
def generate_pasec_prompt(role, mode, option, user_input, upload_count, language, is_pro):
    """
    ç”Ÿæˆç¬¦åˆ PASEC ç»“æ„çš„ Promptã€‚
    """
    # 1. ç¡®å®šæ°´å°
    watermark = ""
    if not is_pro:
        watermark = "\n\n---\nğŸ”’ [Trial Version] Generated by PromptLab AI (Free)"

    # 2. æ ¹æ®é€‰é¡¹æ„å»ºå†…å®¹ (Mock Logic)
    # è¿™é‡Œæ¨¡æ‹Ÿ AI çš„æ€è€ƒè¿‡ç¨‹ï¼Œå®é™…ä¸Šæ˜¯æ ¹æ®æ¨¡æ¿å¡«ç©º
    
    context_str = f"User Input: {user_input}"
    if upload_count > 0:
        context_str += f"\n[System] Analyzed {upload_count} uploaded reference files."

    # 3. ç»„è£… PASEC ç»“æ„
    # å¼ºåˆ¶åŒ…å« 5 å¤§æ ‡é¢˜
    
    prompt_content = f"""# Generated Prompt ({language})

## ğŸ‘¤ P - Persona (è§’è‰²)
**Role**: {role}
**Mode**: {mode}
**Tone**: Professional & Engaging
**Language**: Target Output in {language}

## ğŸ¯ A - Aim (ç›®æ ‡)
**Task**: Execute specific task based on option "{option}".
**Goal**: Create high-quality content that meets professional standards.

## ğŸ“‚ S - Structure (æ ¼å¼)
**Output Format**: Markdown
**Layout**: Logical flow with clear headings and bullet points.

## ğŸ“ E - Effective (é™åˆ¶)
**Constraints**: 
- Avoid unnecessary fluff.
- Maintain strict adherence to the requested tone.
- Ensure cultural relevance for {language} audience.

## ğŸ’¡ C - Context (æƒ…å¢ƒ)
{context_str}

---
**[AI Generation Start]**

(Here, the AI would generate the specific content for "{option}"...)

Based on your request "{user_input}", here is the draft:

1. **Core Concept**: Focusing on the key elements of {option}.
2. **Details**: Expanding on the topic with depth and clarity.
3. **Actionable Steps**: 
   - Step 1: Analyze the requirements.
   - Step 2: Apply the {mode} framework.
   - Step 3: Review and refine.

*(End of Generation)*{watermark}
"""
    return prompt_content

# 5. PDF ç”Ÿæˆå™¨ (å¸¦é˜²å´©æºƒæœºåˆ¶)
# ------------------------------------------
def create_pdf_bytes(content):
    """
    å°†æ–‡æœ¬è½¬æ¢ä¸º PDF äºŒè¿›åˆ¶æµã€‚
    åŒ…å«å­—ä½“å›é€€é€»è¾‘ã€‚
    """
    pdf = FPDF()
    pdf.add_page()
    pdf.set_auto_page_break(auto=True, margin=15)
    
    font_path = 'font.ttf'
    has_custom_font = False
    
    # å°è¯•åŠ è½½ä¸­æ–‡å­—ä½“
    if os.path.exists(font_path):
        try:
            pdf.add_font('CustomFont', '', font_path, uni=True)
            pdf.set_font('CustomFont', '', 12)
            has_custom_font = True
        except:
            pass
            
    # å¦‚æœæ²¡æœ‰å­—ä½“ï¼Œå›é€€åˆ° Arial å¹¶è¿‡æ»¤éæ‹‰ä¸å­—ç¬¦
    if not has_custom_font:
        pdf.set_font("Arial", size=12)
        pdf.set_text_color(255, 0, 0)
        pdf.cell(0, 10, txt="[System Warning: 'font.ttf' not found. CJK characters removed.]", ln=True)
        pdf.set_text_color(0, 0, 0)
        
        # ç®€å•çš„è¿‡æ»¤é€»è¾‘ï¼Œåªä¿ç•™ Latin-1 å­—ç¬¦ï¼Œé˜²æ­¢æŠ¥é”™
        safe_content = content.encode('latin-1', 'ignore').decode('latin-1')
        pdf.multi_cell(0, 10, txt=safe_content)
    else:
        # æœ‰å­—ä½“ï¼Œç›´æ¥è¾“å‡º
        pdf.multi_cell(0, 10, txt=content)
        
    return pdf.output(dest='S').encode('latin-1')

# 6. æ™ºèƒ½å·¥å•æ‹¦æˆªé€»è¾‘
# ------------------------------------------
def check_ticket_intercept(subject, message):
    """
    æ£€æŸ¥æ˜¯å¦åŒ…å«æ‹¦æˆªå…³é”®è¯ã€‚
    è¿”å›: (should_intercept, reply_message)
    """
    full_text = (subject + " " + message).lower()
    
    # å…³é”®è¯åº“
    refund_words = ["refund", "money back", "return", "cancel"]
    key_words = ["key", "license", "code", "lost", "invalid"]
    
    if any(w in full_text for w in refund_words):
        return True, "ğŸš« **Policy Notice**: As stated in our FAQ, digital products are **Non-Refundable**. Please check the 'Billing' section."
        
    if any(w in full_text for w in key_words):
        return True, "ğŸ’¡ **AI Suggestion**: Lost your key? You can recover it instantly at [LemonSqueezy Orders](https://app.lemonsqueezy.com/my-orders)."
        
    return False, None